# 10 | Lambda架构：Twitter亿级实时数据分析架构背后的倚天剑

现实中常见的场景是，我们需要依据用户海量的网站访问行为，来建立一个分析模型，然后根据这个模型精准投放用户喜好的广告。

批处理架构无疑可以实现，但它有着高延时性的特点。而互联网用户行为的数据规模十分庞大，通常可以达到 Pb 、 Eb，甚至是 Zb 的级别。通过批处理做分析挖掘用户行为，模型会耗时好几个小时甚至是几天，再精准投放给特定用户，广告就会有一定延时了。

但只用流处理架构也不可行。只用流处理架构，会忽略了用户的历史网站访问行为，被用户的当前特殊行为干扰，投放错误的广告。例如，用户 B暂时借来用户 A的电脑使用 ，用户 B 浏览了新的网站类型（与用户 A 不同）后，我们无法判断用户 A 实际感兴趣的广告。所以不能只根据流处理架构中的新浏览记录给用户 A 推送广告。

## Lambda 架构

Lambda 架构的大规模分布式数据处理系统，具有很好的灵活性和可扩展性，也对硬件故障和人为失误有很好的容错性。Lambda 架构总共由三层系统组成：批处理层（Batch Layer），速度处理层（Speed Layer），以及用于响应查询的服务层（Serving Layer）。

![img](https://static001.geekbang.org/resource/image/8f/23/8fe667211309978b2dd6cb6948939923.jpg)

批处理层存储管理主数据集（不可变的数据集）和预先计算好的视图。批处理层通过处理所有的已有历史数据，预先计算结果。、它是基于完整的数据集来重新计算的，因此准确性较高，能够修复任何错误。批处理的输出通常在只读数据库中，通过更新完全取代现有的预先计算好的视图。

速度处理层实时处理新来大数据。速度层通过提供最新数据的实时视图来最小化延迟。速度层所生成的数据视图可能不如批处理层最终生成的视图那样准确或完整，但它们在收到数据后几乎是立即可用。而当同样的数据在批处理层处理完成后，在速度层的数据就可以被替代掉了。

本质上，速度层弥补了批处理层所导致的数据视图滞后。所有在批处理层和速度层处理完的结果都输出存储在服务层中，服务层通过返回预先计算的数据视图或从速度层处理构建好的数据视图来响应查询。

所有的新用户行为数据都可以同时流入批处理层和速度层。批处理层会永久保存数据并且对数据进行预处理，得到用户行为模型并写入服务层。而速度层也同时对新用户行为数据进行处理，得到实时的用户行为模型。

## Twitter 的数据分析案例

![img](https://static001.geekbang.org/resource/image/60/20/607c18bece2d57048506374048e74220.jpg)

在这个实际案例里，我们先用 twitter4J 的流处理 API 抓取实时的 Twitter 推文，同时利用 Apache Kafka 将抓取到的数据保存并实时推送给批处理层和速度层。因为 Apache Spark 平台中既有批处理架构也兼容了流处理架构，所以我们选择在批处理层和速度层都采用 Apache Spark 来读取来自 Apache Kafka 的数据。批处理层和速度层在分析处理好数据后会将数据视图输出存储在服务层中，我们将使用 Apache Cassandra 平台来存储他们的数据视图。Apache Cassandra 将批处理层的视图数据和速度层的实时视图数据结合起来，就可以得到一系列有趣的数据。

## Smart Parking 案例分析

这些停车场的历史数据或者每隔半小时拿到的停车位数据，我们可以把它作为批处理层的数据。

那速度层的数据呢？我们可以将所有用户的 GPS 数据聚集起来，这些需要每秒收集的 GPS 数据刚好又是速度层所擅长的实时流处理数据。从这些用户的实时 GPS 数据中，我们可以再建立一套预测模型来预测附近停车场位置的拥挤程度。

服务层将从批处理层和速度层得到的分数结合后将得到最高分数的停车场推荐给用户。这样利用了历史数据（停车场数据）和实时数据（用户 GPS 数据）能大大提升推荐的准确率。

## 小结

在了解 Lambda 架构后，我们知道 Lambda 架构具有很好的灵活性和可扩展性。我们可以很方便地将现有的开源平台套用入这个架构中，如下图所示。

![img](https://static001.geekbang.org/resource/image/e8/8b/e874291dc460e8bfdbe8221ce0fe3d8b.jpg)

## 思考题

你所做的项目开发能否利用 Lambda 架构呢？在生活中有没有哪些大数据处理场景可以利用 Lambda 架构呢？