# 08 | 发布/订阅模式：流处理架构中的瑞士军刀

发布 / 订阅模式（Publish/Subscribe Pattern），有些地方也称它为 Pub/Sub。

## 消息

在分布式架构里，架构中的各个组件（Component）需要相互联系沟通，而各个组件间就是依靠通过发送消息互相通讯的。

组件可以是后台的数据库，可以是前端的浏览器，也可以是公司内部不同的服务终端（Service Endpoint）。如下图所示。

![img](https://static001.geekbang.org/resource/image/36/90/360c700398719d1abb62e202ab9dd390.jpg)

## 消息队列

消息队列在发布 / 订阅模式中起的是一个持久化缓冲（Durable Buffer）的作用。消息的发送方可以发送任意消息至这个消息队列中，消息队列在接收到消息之后会将消息保存好，直到消息的接收方确认已经从这个队列拿到了这个消息，才会将这条消息从消息队列中删除。

有的消息系统平台如 Apache Kafka，它能够让用户自己定义消息队列对消息的保留时间。

![img](https://static001.geekbang.org/resource/image/1e/2e/1ee9fe4ed0fcc75710e718784e03cd2e.jpg)

## 发布 / 订阅模式

发布 / 订阅模式指的是消息的发布者（Publisher）可以将消息异步地发送给一个系统中不同组件，而无需知道订阅者（Subscriber）是谁。

发布者将消息发送到消息队列中，订阅者可以从消息队列里取出自己感兴趣的消息。

在发布 / 订阅模式里，可以有任意多个发布者发送消息，也可以有任意多个订阅者接收消息，如下图所示。

![img](https://static001.geekbang.org/resource/image/d7/a4/d7a10c4975ad59e11c05a357f0e7f5a4.jpg)

观察者模式（Observer Pattern）指的是，每一次有一个新的系统想从团队里读取数据的话，都要双方开会讨论，定义一个新的 API，然后修改支付团队现有的系统，将 API 加入系统中。

而且这些 API 通常都是同步调用的，过多的 API 调用会让系统的延迟越来越大，系统中的各个组件紧耦合（Tightly Coupled）在一起。

如果是采用发布 / 订阅模式来重新设计呢？整个系统就如下图所示：

![img](https://static001.geekbang.org/resource/image/f2/00/f2f3daa13f6db54f96c1c18f61a93200.jpg)

采用这样的数据处理模式，作为消息发布者的支付团队无需过多考虑以后有多少其它的团队需要读取交易数据，只需要设计好自己提供的数据内容与格式，在每次交易发生时发送消息进消息队列中就可以了。任何对这些数据感兴趣的团队只需要从消息队列中自行读取便可。

## 发布 / 订阅模式的优缺点

发布 / 订阅模式会有以下几个优点：

1. 松耦合（Loose Coupling）：消息的发布者和消息的订阅者在开发的时候完全不需要事先知道对方的存在，可以独立地进行开发。

2. 高伸缩性（High Scalability）：发布 / 订阅模式中的消息队列可以独立的作为一个数据存储中心存在。在分布式环境中，更是消息队列更是可以扩展至上千个服务器中。

3. 系统组件间通信更加简洁：因为不需要为每一个消息的订阅者准备专门的消息格式，只要知道了消息队列中保存消息的格式，发布者就可以按照这个格式发送消息，订阅者也只需要按照这个格式接收消息。

但发布 / 订阅模式也存在缺点。例如，在整个数据模式中，发布者发送的数据不一定会送达订阅者。如果要保证数据一定送达的话，需要开发者自己实现响应机制。

在 Apache Kafka 中，消息的发送方被称为 Producer，消息的接收方被称为 Consumer，而消息队列被称为 Topic。

![img](https://static001.geekbang.org/resource/image/b3/0e/b31f636250ed7e4ea9d20ef6bac3e90e.jpg)

Apache Kafka 在判断消息是否被接收方接收是利用了 Log offset 机制。

消息队列需要接收到连续的log offset才会判定接收方接收到消息，如果log offset从10002断开了，所以消息队列会认为接收方从10002开始往后的消息都没有接收到。

## 发布 / 订阅模式的适用场景

1. 系统的发送方需要向大量的接收方广播消息。

2. 系统中某一个组件需要与多个独立开发的组件或服务进行通信，而这些独立开发的组件或服务可以使用不同的编程语言和通信协议。

3. 系统的发送方在向接收方发送消息之后无需接收方进行实时响应。

4. 系统中对数据一致性的要求只需要支持数据的最终一致性（Eventual Consistency）模型。

   如果系统的发送方在向接收方发送消息之后，需要接收方进行实时响应的话，那么绝大多数情况下，都不要考虑使用发布 / 订阅的数据处理模式。

## 小结

发布 / 订阅模式它能够很好地解耦（Decouple）系统中不同的组件，许多实时的流处理架构就是利用这个数据处理的设计模式搭建起来的。因为发布 / 订阅模式同时具有很好的伸缩性。

## 思考题

你认为微信的朋友圈功能适合使用发布 / 订阅模式吗？为什么？

盆友圈适合使用pub/sub模式

1. 消息发送方需要向多个接收方（n个可以看自己盆友圈的好友）广播消息
2. 多消费者组（微信朋友圈数据应该不仅仅只是用于社交，可能还有其他作用吧，所以可能会有多个模块需要用到这份数据）
3. 发送方发送消息之后是不需要接收方立即进行响应的（异步），所以用消息队列可以有效起到解耦的作用
4. 微信朋友圈对于数据而言，满足最终一致性的